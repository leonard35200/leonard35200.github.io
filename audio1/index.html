<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>57 rue du soleil</title>
<style>
  body { font-family: sans-serif; margin:0; background:#f6f6f6; color:#333; text-align:center; }
  h1 { background:black; color:white; margin:0; padding:1em; }
  #imagePlay { width:200px; height:200px; margin:40px auto; cursor:pointer; object-fit:cover; display:block; border-radius:10px; }
  #playerUI { display:none; margin-top:20px; }
  #progressContainer { position:relative; width:80%; max-width:600px; height:15px; background:#ddd; border-radius:10px; margin:20px auto; cursor:pointer; overflow:hidden; }
  #progressBar { height:100%; width:0%; background:linear-gradient(90deg,#4a90e2,#7b4397); border-radius:10px; transition:width 0.2s linear; }
  #volumeContainer { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; }
  #chapter { font-size:1.1em; margin-bottom:20px; font-weight:bold; }
  input[type="range"] { width:100px; }
  button { margin:5px; padding:8px 16px; font-size:1em; border:none; border-radius:20px; cursor:pointer; background:black; color:white; }
  button:hover { background:#222; }
  .progress-pulse { animation:pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow:0 0 5px #4a90e2; } 50% { box-shadow:0 0 15px #7b4397; } 100% { box-shadow:0 0 5px #4a90e2; } }
</style>
</head>
<body>
<h1>Audio 57 rue du soleil</h1>
<img src="audio.png" id="imagePlay" alt="Lire / mettre en pause le livre audio">

<div id="playerUI">
  <div id="timeContainer" style="display:flex; justify-content:space-between; width:80%; max-width:600px; margin:0 auto; font-size:0.9em;">
  <span id="elapsed">0:00</span>
  <span id="remaining">-0:00</span>
</div>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <div id="volumeContainer">üîä <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1"></div>
  <div id="chapter">Chapitre 0</div>
  <button id="prevChapterBtn">Chapitre pr√©c√©dent ‚èÆÔ∏è</button>
  <button id="pauseBtn">Lecture / Pause ‚èØÔ∏è</button>
  <button id="nextChapterBtn">Chapitre suivant ‚è≠Ô∏è</button>
  <button id="rewindBtn">‚è™ 15s</button>
  <button id="forwardBtn">15s ‚è©</button>
</div>

<audio id="audioPlayer"></audio>

<script>
// --- Param√®tres (fichiers tri√©s par num√©ro) --- //
const files = [
  '0.Intro et remerciment Jean.mp3',
  '1. pr√©face.mp3',
  '3. Chap 2.mp3',
  '4. Chap 3.mp3',
  '5. Chap 4.mp3',
  '6. Chap 5.mp3',
  '7. Chap 6.mp3',
  '8. Chap 7.mp3',
  '9. Chap 8.mp3',
  '10. Chap 9.mp3',
  '11. Chap 10.mp3',
  '12. Chap 11.mp3',
  '13. Chap 12.mp3',
  '14. Chap 13.mp3',
  '15. Chap 14.mp3',
  '16. Chap 15.mp3',
  '17. Chap 16.mp3',
  '18. Chap 17.mp3',
  '19. Chap 18.mp3',
  '20. Chap 19.mp3',
  '21. Chap 20.mp3',
  '22. Chap 21.mp3',
  '23. Chap 22.mp3',
  '24. Chap 23.mp3',
  '25. Chap 24.mp3',
  '26. Chap 25.mp3'
  //,'intro Flo.mp3'
];

const durations = [
  14,     // 0.Intro et remerciment Jean.mp3
  19.5,   // 1. pr√©face.mp3
  308,    // 3. Chap 2.mp3
  46,     // 4. Chap 3.mp3
  470,    // 5. Chap 4.mp3
  239,    // 6. Chap 5.mp3
  58,     // 7. Chap 6.mp3
  305,    // 8. Chap 7.mp3
  196,    // 9. Chap 8.mp3
  101,    // 10. Chap 9.mp3
  374,    // 11. Chap 10.mp3
  289.5,  // 12. Chap 11.mp3
  85.3,   // 13. Chap 12.mp3
  363.2,  // 14. Chap 13.mp3
  249.5,  // 15. Chap 14.mp3
  90.5,   // 16. Chap 15.mp3
  314,    // 17. Chap 16.mp3
  160,    // 18. Chap 17.mp3
  92,     // 19. Chap 18.mp3
  213,    // 20. Chap 19.mp3
  330.5,  // 21. Chap 20.mp3
  330.5,  // 22. Chap 21.mp3
  438.5,  // 23. Chap 22.mp3
  312,    // 24. Chap 23.mp3
  473,    // 25. Chap 24.mp3
  352.5,  // 26. Chap 25.mp3
  //6       // intro Flo.mp3 
];

const totalDuration = durations.reduce((a,b)=>a+b,0);

// --- Variables DOM --- //
const player = document.getElementById('audioPlayer');
const imagePlay = document.getElementById('imagePlay');
const playerUI = document.getElementById('playerUI');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const volumeControl = document.getElementById('volumeControl');
const chapterEl = document.getElementById('chapter');
const pauseBtn = document.getElementById('pauseBtn');
const prevBtn = document.getElementById('prevChapterBtn');
const nextBtn = document.getElementById('nextChapterBtn');
const rewindBtn = document.getElementById('rewindBtn');
const forwardBtn = document.getElementById('forwardBtn');
const elapsedEl = document.getElementById('elapsed');
const remainingEl = document.getElementById('remaining');

let db;
let currentIndex = 0;
let lastPosition = 0;
let hasStarted = false;

// --- Formatage du temps --- //
function formatTime(seconds){
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

// --- IndexedDB --- //
const request = indexedDB.open('audioProgressDB',1);
request.onupgradeneeded = e=>{
  db = e.target.result;
  if (!db.objectStoreNames.contains('progress')) db.createObjectStore('progress',{keyPath:'id'});
};
request.onsuccess = e=>{
  db = e.target.result;
  const tx = db.transaction('progress','readonly');
  const store = tx.objectStore('progress');
  const getReq = store.get('state');
  getReq.onsuccess = ()=>{
    const data = getReq.result;
    if(data){
      currentIndex = data.index || 0;
      lastPosition = data.time || 0;
    }
  };
};

// --- Sauvegarde --- //
function saveProgress(){
  if(!db) return;
  const tx = db.transaction('progress','readwrite');
  const store = tx.objectStore('progress');
  store.put({id:'state', index:currentIndex, time:player.currentTime});
}

// --- Lecture --- //
function loadTrack(index, start=0){
  if(index >= files.length){
    chapterEl.textContent = "Fin du livre";
    progressBar.style.width = "100%";
    elapsedEl.textContent = formatTime(totalDuration);
    remainingEl.textContent = "-0:00";
    return;
  }
  player.src = files[index];
  player.currentTime = start;
  player.play();
  chapterEl.textContent = "Chapitre " + index;
  hasStarted = true;
  playerUI.style.display = "block";
  progressBar.classList.add('progress-pulse');
}

// --- Progression --- //
function updateProgress(){
  const playedBefore = durations.slice(0,currentIndex).reduce((a,b)=>a+b,0);
  const playedTotal = playedBefore + player.currentTime;
  const percent = (playedTotal / totalDuration) * 100;
  progressBar.style.width = percent + "%";

  // --- Temps √©coul√© et restant ---
  elapsedEl.textContent = formatTime(playedTotal);
  const remainingTotal = totalDuration - playedTotal;
  remainingEl.textContent = "-" + formatTime(Math.max(0, remainingTotal));
}

// --- Boutons --- //
imagePlay.addEventListener('click',()=>{
  if(!hasStarted){
    loadTrack(currentIndex,lastPosition);
  } else {
    player.paused ? player.play() : player.pause();
  }
});

pauseBtn.addEventListener('click',()=>{ player.paused ? player.play() : player.pause(); });
prevBtn.addEventListener('click',()=>{
  if(currentIndex > 0){
    currentIndex--;
    loadTrack(currentIndex,0);
  }
});
nextBtn.addEventListener('click',()=>{
  if(currentIndex < files.length - 1){
    currentIndex++;
    loadTrack(currentIndex,0);
  }
});
rewindBtn.addEventListener('click',()=>{ player.currentTime = Math.max(0, player.currentTime - 15); });
forwardBtn.addEventListener('click',()=>{ player.currentTime = Math.min(player.duration, player.currentTime + 15); });

// --- √âv√©nements --- //
player.addEventListener('timeupdate',()=>{
  updateProgress();
  saveProgress();
});
player.addEventListener('ended',()=>{
  currentIndex++;
  if(currentIndex < files.length){
    loadTrack(currentIndex,0);
  } else {
    progressBar.style.width = "100%";
    chapterEl.textContent = "Fin du livre";
    elapsedEl.textContent = formatTime(totalDuration);
    remainingEl.textContent = "-0:00";
  }
});

// --- Volume --- //
volumeControl.addEventListener('input', e=>{ player.volume = e.target.value; });

// --- Mise en pause si l‚Äôonglet est masqu√© --- //
document.addEventListener('visibilitychange',()=>{ if(document.hidden) player.pause(); });

// --- Sauvegarde avant fermeture --- //
window.addEventListener('beforeunload', saveProgress);
</script>


</body>
</html>