<style>
.responsive-container { margin: 0 auto; padding: 0 5%; max-width: 800px; }
.responsive-containerHaut { margin: 0 auto; padding: 0 5%; max-width: 800px; }
#Intro {font-size: clamp(18px, 2.5vw, 22px); font-weight: bold; color: #cc4c25; margin-bottom: 20px; text-align: center; }
body { font-family: sans-serif; margin:0; background:#f6f6f6; color:#333; text-align:center; }
 h1 {
  background: #e6a585;
  color: #1a1a1a;
  margin: 0;
  padding: 1.2rem 1rem;
  font-weight: 700;
  font-size: 1.5rem;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

  #imagePlay {
  width: clamp(120px, 50vw, 280px);
  height: auto;
  transition: width 0.4s ease;
}

#imagePlay.small {
  width: clamp(120px, 30vw, 220px);
}
  #playerUI { display:none; margin-top:20px; }
  #progressContainer { position:relative; width:80%; max-width:600px; height:15px; background:#ddd; border-radius:10px; margin:20px auto; cursor:pointer; overflow:hidden; }
  #progressBar { height:100%; width:0%; background:linear-gradient(90deg,#4a90e2,#7b4397); border-radius:10px; transition:width 0.2s linear; }
  #volumeContainer { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; }
  #chapter { font-size:1.1em; margin-bottom:20px; font-weight:bold; }
  input[type="range"] { width:100px; }
  button { margin:5px; padding:8px 16px; font-size:1em; border:none; border-radius:20px; cursor:pointer; background:black; color:white; }
  button:hover { background:#222; }
  .progress-pulse { animation:pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow:0 0 5px #4a90e2; } 50% { box-shadow:0 0 15px #7b4397; } 100% { box-shadow:0 0 5px #4a90e2; } }
  p {
  text-align: left;          /* alignement √† gauche */
  line-height: 1.6;          /* pour faciliter la lecture */
  font-size: clamp(16px, 2vw, 20px);  /* taille responsive : minimum 16px, maximum 20px, 2vw pour s‚Äôadapter √† l‚Äô√©cran */
  max-width: 800px;          /* limite la largeur pour ne pas √©tirer le texte sur grand √©cran */
  margin: 20px auto;         /* centrage horizontal du bloc si tu veux limiter sa largeur */
  color: #333;               /* couleur de texte agr√©able */
}

figcaption {
  font-size: clamp(14px, 1.5vw, 16px);
  color: #555;
  margin-top: 10px;
  text-align: center;
  transition: opacity 0.3s ease;
}
figcaption.hidden {
  opacity: 0;
  height: 0;
  overflow: hidden;
}


</style>
<h1>57 rue du soleil - version audio</h1>
<div class="responsive-containerHaut">
<p id="Intro">D√©couvrez ici la version audio de <span style="white-space: nowrap;">57 rue du soleil.</span></p>
</div>

<figure>
  <img src="https://assolibre.fr/wp-content/uploads/2025/10/audio.png" id="imagePlay" alt="afficher / cacher le lecteur audio" title="Cliquer pour afficher / cacher le lecteur audio">
  <figcaption>
    Cliquer sur l‚Äôimage pour afficher ou cacher le lecteur audio.
  </figcaption>
</figure>


<div id="playerUI">
  <div id="timeContainer" style="display:flex; justify-content:space-between; width:80%; max-width:600px; margin:0 auto; font-size:0.9em;">
  <span id="elapsed">0:00</span>
  <span id="remaining">-0:00</span>
</div>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <div id="volumeContainer">üîä <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1"></div>
  <div id="chapter">Chapitre 0</div>
  <button id="prevChapterBtn">Chapitre pr√©c√©dent ‚èÆÔ∏è</button>
  <button id="nextChapterBtn">Chapitre suivant ‚è≠Ô∏è</button> <br>
  <button id="pauseBtn">Lecture / Pause ‚èØÔ∏è</button>
</div>

<audio id="audioPlayer"></audio>

<div class="responsive-container">

<p>Une version audio avec ambiance sonore r√©alis√©e gracieusement par Florence Arnould, com√©dienne - <a href="https://www.ecoutez-voir.com/" style="color:#333;">Compagnie Ecoutez Voir</a></p>
<p> Enregistrement r√©alis√© avec le concours de la <a href="https://romille.fr/mediatheque/" style="color:#333;">m√©diath√®que L'Encrier de Romill√©.</a></p>
<p><strong><span style="color:#cc4c25; font-size:2em;"> Bonne √©coute !</span></strong></p>
<p><a style="color:#cc4c25 ;" href="https://www.assolibre.fr/"> Retour au site de li(b)re</a></p>
</div>
<script>
// --- Param√®tres (noms de fichiers locaux) ---
const files = [
  'https://assolibre.fr/wp-content/uploads/2025/10/0.Intro-et-remerciment-Jean.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/1.-preface.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/3.-Chap-2.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/4.-Chap-3.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/5.-Chap-4.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/6.-Chap-5.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/7.-Chap-6.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/8.-Chap-7.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/9.-Chap-8.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/10.-Chap-9.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/11.-Chap-10.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/12.-Chap-11.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/13.-Chap-12.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/14.-Chap-13.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/15.-Chap-14.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/16.-Chap-15.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/17.-Chap-16.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/18.-Chap-17.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/19.-Chap-18.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/20.-Chap-19.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/21.-Chap-20.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/22.-Chap-21.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/23.-Chap-22.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/24.-Chap-23.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/25.-Chap-24.mp3',
  'https://assolibre.fr/wp-content/uploads/2025/10/26.-Chap-25.mp3'
];

// Exemple : remoteFiles[0] -> "https://assolibre.fr/.../0.Intro%20et%20remerciment%20Jean.mp3"

const durations = [
  14, 19.5, 308, 46, 470, 239, 58, 305, 196, 101, 374, 289.5, 85.3, 363.2, 
  249.5, 90.5, 314, 160, 92, 213, 330.5, 330.5, 438.5, 312, 473, 352.5
];

const totalDuration = durations.reduce((a,b)=>a+b,0);

// --- Variables DOM ---
const player = document.getElementById('audioPlayer');
const imagePlay = document.getElementById('imagePlay');
const playerUI = document.getElementById('playerUI');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const volumeControl = document.getElementById('volumeControl');
const chapterEl = document.getElementById('chapter');
const pauseBtn = document.getElementById('pauseBtn');
const prevBtn = document.getElementById('prevChapterBtn');
const nextBtn = document.getElementById('nextChapterBtn');
const elapsedEl = document.getElementById('elapsed');
const remainingEl = document.getElementById('remaining');

let db;
let currentIndex = 0;
let lastPosition = 0;
let hasStarted = false;

// --- Formatage du temps ---
function formatTime(seconds){
  seconds = Math.floor(seconds);
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  if(h>0) return h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
  return m+':'+(s<10?'0':'')+s;
}

// --- IndexedDB ---
const request = indexedDB.open('audioProgressDB',1);
request.onupgradeneeded = e=>{
  db = e.target.result;
  if(!db.objectStoreNames.contains('progress')) db.createObjectStore('progress',{keyPath:'id'});
};
request.onsuccess = e=>{
  db = e.target.result;
  const tx = db.transaction('progress','readonly');
  const store = tx.objectStore('progress');
  const getReq = store.get('state');
  getReq.onsuccess = ()=>{
    const data = getReq.result;
    if(data){
      currentIndex = data.index || 0;
      lastPosition = data.time || 0;
    }
  };
};

// --- Sauvegarde ---
function saveProgress(){
  if(!db) return;
  const tx = db.transaction('progress','readwrite');
  const store = tx.objectStore('progress');
  store.put({id:'state', index:currentIndex, time:player.currentTime});
}

// --- Lecture ---
function loadTrack(index, start=0){
  if(index >= files.length){
    chapterEl.textContent = "Fin du livre";
    progressBar.style.width = "100%";
    elapsedEl.textContent = formatTime(totalDuration);
    remainingEl.textContent = "-0:00";
    return;
  }
  player.src = files[index];
  player.currentTime = start;
  player.play();
  if (index == 0){
    chapterEl.textContent = "Intro";}
  else if (index == 1){
    chapterEl.textContent = "Pr√©face";}
  else {
    let chap = index - 1
    chapterEl.textContent = "Chapitre " + chap;}
  hasStarted = true;
  playerUI.style.display = "block";
  progressBar.classList.add('progress-pulse');
}

// --- Progression ---
function updateProgress(){
  const playedBefore = durations.slice(0,currentIndex).reduce((a,b)=>a+b,0);
  const playedTotal = playedBefore + player.currentTime;
  const percent = (playedTotal / totalDuration) * 100;
  progressBar.style.width = percent + "%";

  elapsedEl.textContent = formatTime(playedTotal);
  const remainingTotal = totalDuration - playedTotal;
  remainingEl.textContent = "reste " + formatTime(Math.max(0, remainingTotal));
}

// --- Barre cliquable ---
progressContainer.addEventListener('click', (e) => {
  const rect = progressContainer.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const width = rect.width;
  const percent = clickX / width;

  // Calcul du temps absolu sur tout le livre
  const targetTotalTime = percent * totalDuration;

  // Trouver le chapitre correspondant
  let cumulative = 0;
  for (let i = 0; i < durations.length; i++) {
    if (cumulative + durations[i] > targetTotalTime) {
      currentIndex = i;
      const timeInChapter = targetTotalTime - cumulative;
      loadTrack(currentIndex, timeInChapter);
      break;
    }
    cumulative += durations[i];
  }
});


// --- Boutons ---
imagePlay.addEventListener('click', () => {
  const figcaptionEl = imagePlay.nextElementSibling;

  if (!hasStarted) {
    loadTrack(currentIndex, lastPosition);
    playerUI.style.display = 'block';
    imagePlay.classList.add('small'); // image devient plus petite quand lecteur visible
    figcaptionEl.classList.add('hidden');
  } else {
    if (playerUI.style.display === 'block') {
      playerUI.style.display = 'none';
      player.pause();
      imagePlay.classList.remove('small'); // image redevient grande
      figcaptionEl.classList.remove('hidden');
    } else {
      playerUI.style.display = 'block';
      player.play();
      imagePlay.classList.add('small'); // redevient petite
      figcaptionEl.classList.add('hidden');
    }
  }
});

pauseBtn.addEventListener('click',()=>{ player.paused ? player.play() : player.pause(); });
prevBtn.addEventListener('click',()=>{ if(currentIndex>0){ currentIndex--; loadTrack(currentIndex,0); } });
nextBtn.addEventListener('click',()=>{ if(currentIndex<files.length-1){ currentIndex++; loadTrack(currentIndex,0); } });

// --- √âv√©nements ---
player.addEventListener('timeupdate',()=>{ updateProgress(); saveProgress(); });
player.addEventListener('ended',()=>{ currentIndex++; if(currentIndex<files.length){ loadTrack(currentIndex,0); } else { progressBar.style.width="100%"; chapterEl.textContent="Fin du livre"; elapsedEl.textContent=formatTime(totalDuration); remainingEl.textContent="-0:00"; } });

// --- Volume ---
volumeControl.addEventListener('input', e=>{ player.volume = e.target.value; });

// --- Pause si onglet masqu√© ---
document.addEventListener('visibilitychange',()=>{ if(document.hidden) player.pause(); });

// --- Sauvegarde avant fermeture ---
window.addEventListener('beforeunload', saveProgress);

// --- Initialiser le temps au chargement ---
updateProgress();

</script>

